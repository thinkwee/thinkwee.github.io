<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css2?family=Noto+Serif+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"thinkwee.top","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"duration":50,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="The school’s innovation project has a simple app that implements the following functions: recording sound and saving it as a wav file, using JSON to communicate with the server, uploading the wav fil">
<meta property="og:type" content="article">
<meta property="og:title" content="Notes for my Android app - Melodia">
<meta property="og:url" content="https://thinkwee.top/2017/03/09/dachuang/index.html">
<meta property="og:site_name" content="Thinkwee&#39;s Blog">
<meta property="og:description" content="The school’s innovation project has a simple app that implements the following functions: recording sound and saving it as a wav file, using JSON to communicate with the server, uploading the wav fil">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.mji.rip/2025/07/16/881fef7085a3a58b245072cf7c2b8e81.png">
<meta property="og:image" content="https://s1.ax1x.com/2018/10/20/i0o26O.gif">
<meta property="article:published_time" content="2017-03-09T09:19:53.000Z">
<meta property="article:modified_time" content="2025-07-16T10:46:36.900Z">
<meta property="article:author" content="Thinkwee">
<meta property="article:tag" content="code">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.mji.rip/2025/07/16/881fef7085a3a58b245072cf7c2b8e81.png">


<link rel="canonical" href="https://thinkwee.top/2017/03/09/dachuang/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://thinkwee.top/2017/03/09/dachuang/","path":"2017/03/09/dachuang/","title":"Notes for my Android app - Melodia"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Notes for my Android app - Melodia | Thinkwee's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-96114782-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-96114782-1","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script>(function() {function calculateHeight(element) {let height = 0;const items = element.children;for (let i = 0; i < items.length; i++) {height += items[i].offsetHeight || 25;const child = items[i].querySelector(".nav-child");if (child && child.style.display !== "none") {height += calculateHeight(child);}}return height;}function generateToc(lang, container) {const content = document.getElementById(lang + "-content");if (!content) return;const headers = Array.from(content.querySelectorAll("h1, h2, h3, h4, h5, h6"));if (headers.length === 0) return;const ol = document.createElement("ol");ol.className = "nav";let currentLevel = 1;let currentOl = ol;let stack = [ol];let counters = [0, 0, 0, 0, 0, 0];headers.forEach((header, index) => {const level = parseInt(header.tagName[1]);counters[level - 1]++;for (let i = level; i < 6; i++) counters[i] = 0;const li = document.createElement("li");li.className = "nav-item nav-level-" + level;if (level === 1 && index === 0) {li.classList.add("active", "active-current");}const link = document.createElement("a");link.className = "nav-link";if (level === 1 && index === 0) link.classList.add("active");link.href = "#" + header.id;const numSpan = document.createElement("span");numSpan.className = "nav-number";numSpan.textContent = counters.slice(0, level).filter(n => n > 0).join(".");const textSpan = document.createElement("span");textSpan.className = "nav-text";textSpan.textContent = header.textContent;link.appendChild(numSpan);link.appendChild(document.createTextNode(" "));link.appendChild(textSpan);li.appendChild(link);if (level > currentLevel) {const newOl = document.createElement("ol");newOl.className = "nav-child";if (currentLevel === 1) {newOl.style.display = "block";stack[currentLevel - 1].lastElementChild.classList.add("active");}stack[currentLevel - 1].lastElementChild.appendChild(newOl);stack[level - 1] = newOl;currentOl = newOl;} else if (level < currentLevel) {currentOl = stack[level - 1];}currentOl.appendChild(li);currentLevel = level;});container.appendChild(ol);setTimeout(() => {const navHeight = calculateHeight(ol);ol.style.setProperty("--height", navHeight + "px");const navChilds = ol.getElementsByClassName("nav-child");Array.from(navChilds).forEach(child => {if (child.style.display === "block") {const childHeight = calculateHeight(child);child.style.setProperty("--height", childHeight + "px");}});}, 0);return ol;}function updateActiveHeading() {const activeLang = document.getElementById("en-content").style.display === "block" ? "en" : "zh";const content = document.getElementById(activeLang + "-content");const toc = document.getElementById(activeLang + "-toc");if (!content || !toc) return;const headers = Array.from(content.querySelectorAll("h1, h2, h3, h4, h5, h6"));const scrollPos = window.scrollY + window.innerHeight / 3;let activeHeader = null;for (let i = headers.length - 1; i >= 0; i--) {const header = headers[i];const headerTop = header.getBoundingClientRect().top + window.scrollY;if (headerTop <= scrollPos) {activeHeader = header;break;}}const links = toc.getElementsByClassName("nav-link");Array.from(links).forEach(link => {link.classList.remove("active");const parentLi = link.parentElement;if (parentLi) {parentLi.classList.remove("active", "active-current");}});if (activeHeader) {const activeLink = toc.querySelector(`a[href="#${activeHeader.id}"]`);if (activeLink) {activeLink.classList.add("active");let parent = activeLink.parentElement;while (parent && parent.classList) {if (parent.classList.contains("nav-item")) {parent.classList.add("active");if (parent.classList.contains("nav-level-1")) {parent.classList.add("active-current");}}parent = parent.parentElement;}}}}function initTippy() {document.querySelectorAll(".refplus-num").forEach((ref) => {if (ref._tippy) {ref._tippy.destroy();}let refid = ref.firstChild.href.replace(location.origin+location.pathname,"");let refel = document.querySelector(refid);if (!refel) return;let refnum = refel.dataset.num;let ref_content = refel.innerText.replace(`[${refnum}]`,"");tippy(ref, {content: ref_content,});});}function initToc() {const originalToc = document.querySelector(".post-toc-wrap");if (!originalToc || !document.getElementById("langToggle")) return;const tocContainer = document.createElement("div");tocContainer.className = "post-toc-wrap sidebar-panel sidebar-panel-active";const enToc = document.createElement("div");enToc.id = "en-toc";enToc.className = "post-toc motion-element";enToc.style.display = "block";const zhToc = document.createElement("div");zhToc.id = "zh-toc";zhToc.className = "post-toc motion-element";zhToc.style.display = "none";generateToc("en", enToc);generateToc("zh", zhToc);tocContainer.appendChild(enToc);tocContainer.appendChild(zhToc);originalToc.parentNode.replaceChild(tocContainer, originalToc);window.addEventListener("scroll", updateActiveHeading);setTimeout(updateActiveHeading, 0);}window.toggleLanguage = function() {const enContent = document.getElementById("en-content");const zhContent = document.getElementById("zh-content");const enToc = document.getElementById("en-toc");const zhToc = document.getElementById("zh-toc");const button = document.getElementById("langToggle");if (!enContent || !zhContent || !enToc || !zhToc || !button) return;const isEnglish = enContent.style.display === "block";enContent.style.display = isEnglish ? "none" : "block";zhContent.style.display = isEnglish ? "block" : "none";enToc.style.display = isEnglish ? "none" : "block";zhToc.style.display = isEnglish ? "block" : "none";button.querySelector(".button-text").textContent = isEnglish ? "Switch to English" : "切换中文";setTimeout(updateActiveHeading, 0);setTimeout(initTippy, 100);};document.addEventListener("DOMContentLoaded", function() {initToc();setTimeout(initTippy, 3000);});})();</script><style>.post-toc { transition: all 0.2s ease-in-out; }.post-toc .nav { padding-left: 0; }.post-toc .nav-child { padding-left: 1em; }.post-toc .nav-item { line-height: 1.8; }.post-toc .nav-link { color: #555; }.post-toc .nav-link:hover { color: #222; }.post-toc .nav-link.active { color: #fc6423; }.post-toc .active > .nav-link { color: #fc6423; }.post-toc .active-current > .nav-link { color: #fc6423; }</style><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Thinkwee's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Too Stupid to Give Up Learning</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">50</span></a></li><li class="menu-item menu-item-multi-agent-ebook"><a href="/multiagent_ebook/" rel="section"><i class="fa fa-book fa-fw"></i>Multi-Agent EBook</a></li><li class="menu-item menu-item-iagents"><a href="/iagents/" rel="section"><i class="fa fa-robot fa-fw"></i>iAgents</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#midi-playback"><span class="nav-number">1.</span> <span class="nav-text">midi playback</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Recording-and-replaying-sound"><span class="nav-number">2.</span> <span class="nav-text">Recording and replaying sound</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pcm-header-file-converted-to-wav"><span class="nav-number">3.</span> <span class="nav-text">pcm header file converted to wav</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JSON-transmission-and-reception"><span class="nav-number">4.</span> <span class="nav-text">JSON transmission and reception</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#socket-communication"><span class="nav-number">5.</span> <span class="nav-text">socket communication</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Recording-Effects"><span class="nav-number">6.</span> <span class="nav-text">Recording Effects</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Display-musical-score"><span class="nav-number">7.</span> <span class="nav-text">Display musical score</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Communication-with-an-Electronic-Keyboard"><span class="nav-number">8.</span> <span class="nav-text">Communication with an Electronic Keyboard</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pcm%E5%86%99%E5%A4%B4%E6%96%87%E4%BB%B6%E8%BD%AC%E6%88%90wav"><span class="nav-number">9.</span> <span class="nav-text">pcm写头文件转成wav</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#json%E6%94%B6%E5%8F%91"><span class="nav-number">10.</span> <span class="nav-text">json收发</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#socket%E9%80%9A%E4%BF%A1"><span class="nav-number">11.</span> <span class="nav-text">socket通信</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BD%95%E9%9F%B3%E7%89%B9%E6%95%88"><span class="nav-number">12.</span> <span class="nav-text">录音特效</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B1%95%E7%A4%BA%E4%B9%90%E8%B0%B1"><span class="nav-number">13.</span> <span class="nav-text">展示乐谱</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%8E%E7%94%B5%E5%AD%90%E7%90%B4%E9%80%9A%E4%BF%A1"><span class="nav-number">14.</span> <span class="nav-text">与电子琴通信</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Thinkwee</p>
  <div class="site-description" itemprop="description">Failed Better</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/thinkwee" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;thinkwee" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:thinkwee2767@gmail.com" title="E-Mail → mailto:thinkwee2767@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/thinkwee2767" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;thinkwee2767" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://scholar.google.com/citations?hl=en&user=QvW2leIAAAAJ" title="GScholar → https:&#x2F;&#x2F;scholar.google.com&#x2F;citations?hl&#x3D;en&amp;user&#x3D;QvW2leIAAAAJ" rel="noopener me" target="_blank"><i class="fa fa-graduation-cap fa-fw"></i>GScholar</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thinkwee.top/2017/03/09/dachuang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Thinkwee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinkwee's Blog">
      <meta itemprop="description" content="Failed Better">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Notes for my Android app - Melodia | Thinkwee's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Notes for my Android app - Melodia
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-09 17:19:53" itemprop="dateCreated datePublished" datetime="2017-03-09T17:19:53+08:00">2017-03-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-16 18:46:36" itemprop="dateModified" datetime="2025-07-16T18:46:36+08:00">2025-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
    <span id="/2017/03/09/dachuang/" class="post-meta-item leancloud_visitors" data-flag-title="Notes for my Android app - Melodia" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>24 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img data-src="https://i.mji.rip/2025/07/16/881fef7085a3a58b245072cf7c2b8e81.png" width="500"/></p>
<p>The school’s innovation project has a simple app that implements the following functions: recording sound and saving it as a wav file, using JSON to communicate with the server, uploading the wav file to the server, converting it to a midi file on the server, downloading the midi file and sheet music from the server for playback. At the same time, the modified electronic piano can also communicate with the server, with the phone providing auxiliary parameters to the electronic piano, which reads the intermediate key value file of the music from the server via Arduino to play.</p>
<span id="more"></span>
<p><img data-src="https://s1.ax1x.com/2018/10/20/i0o26O.gif" alt="i0o26O.gif"><br>cover use <a target="_blank" rel="noopener" href="https://github.com/qiao">qiao</a>‘s <a target="_blank" rel="noopener" href="https://github.com/qiao/euphony">euphony</a></p>
<style>.lang-content {width: 100%;overflow: hidden;}.lang-content:not(:first-child) {display: none;}</style><div style="text-align: right; margin: 0 0 20px auto; max-width: 200px;"><button id="langToggle" onclick="toggleLanguage()" class="lang-switch-btn" style="width: 100%;padding: 10px 20px;border-radius: 8px;border: 2px solid #2c3e50;background-color: #fff;cursor: pointer;color: #2c3e50;font-size: 15px;transition: all 0.3s ease;display: flex;align-items: center;justify-content: center;gap: 8px;box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><span class="button-text">切换中文</span></button></div>
<div id="en-content" class="lang-content" style="display: block;"><h1 id="midi-playback"><a href="#midi-playback" class="headerlink" title="midi playback"></a>midi playback</h1><p>Invoke MediaPlayer class for playback; due to irresistible factors, only Android 5.1 can be used, and since there is no MIDI library, a simple playback is implemented.</p>
<ul>
<li>MediaPlayer can access and play media files using four methods: external storage, assert, self-built raw folder, or URI</li>
<li>From the raw folder, read directly using player = MediaPlayer.create(this, R.raw.test1)</li>
<li>Uri or external storage read new-&gt;setDataSource-&gt;prepare-&gt;start</li>
</ul>
<h1 id="Recording-and-replaying-sound"><a href="#Recording-and-replaying-sound" class="headerlink" title="Recording and replaying sound"></a>Recording and replaying sound</h1><p>Refer to the use of AudioRecord in Android</p>
<pre><code>    private class RecordTask extends AsyncTask&lt;Void, Integer, Void&gt; {
        @Override
        protected Void doInBackground(Void... arg0) {
            isRecording = true;
            try {
                //开通输出流到指定的文件
                DataOutputStream dos = new DataOutputStream(new BufferedOutputStream(new FileOutputStream(pcmFile)));
                //根据定义好的几个配置，来获取合适的缓冲大小
                int bufferSize = AudioRecord.getMinBufferSize(audioRate, channelConfig, audioEncoding);
                //实例化AudioRecord
                AudioRecord record = new AudioRecord(MediaRecorder.AudioSource.MIC, audioRate, channelConfig, audioEncoding, bufferSize);
                //定义缓冲
                short[] buffer = new short[bufferSize];

                //开始录制
                record.startRecording();

                int r = 0; //存储录制进度
                //定义循环，根据isRecording的值来判断是否继续录制
                while (isRecording) {
                    //从bufferSize中读取字节，返回读取的short个数
                    //这里老是出现buffer overflow，不知道是什么原因，试了好几个值，都没用，TODO：待解决
                    int bufferReadResult = record.read(buffer, 0, buffer.length);
                    //循环将buffer中的音频数据写入到OutputStream中
                    for (int i = 0; i &lt; bufferReadResult; i++) {
                        dos.writeShort(buffer[i]);
                    }
                    publishProgress(new Integer(r)); //向UI线程报告当前进度
                    r++; //自增进度值
                }
                //录制结束
                record.stop();
                convertWaveFile();
                dos.close();
            } catch (Exception e) {
                // TODO: handle exception
            }
            return null;
        }
    }
</code></pre><h1 id="pcm-header-file-converted-to-wav"><a href="#pcm-header-file-converted-to-wav" class="headerlink" title="pcm header file converted to wav"></a>pcm header file converted to wav</h1><p>Because the recording is in a raw file, in PCM format, it requires the addition of a WAV header manually</p>
<pre><code>    private void WriteWaveFileHeader(FileOutputStream out, long totalAudioLen, long totalDataLen, long longSampleRate,
                                     int channels, long byteRate) throws IOException {
        byte[] header = new byte[45];
        header[0] = &#39;R&#39;; // RIFF
        header[1] = &#39;I&#39;;
        header[2] = &#39;F&#39;;
        header[3] = &#39;F&#39;;
        header[4] = (byte) (totalDataLen &amp; 0xff);//数据大小
        header[5] = (byte) ((totalDataLen &gt;&gt; 8) &amp; 0xff);
        header[6] = (byte) ((totalDataLen &gt;&gt; 16) &amp; 0xff);
        header[7] = (byte) ((totalDataLen &gt;&gt; 24) &amp; 0xff);
        header[8] = &#39;W&#39;;//WAVE
        header[9] = &#39;A&#39;;
        header[10] = &#39;V&#39;;
        header[11] = &#39;E&#39;;
        //FMT Chunk
        header[12] = &#39;f&#39;; // &#39;fmt &#39;
        header[13] = &#39;m&#39;;
        header[14] = &#39;t&#39;;
        header[15] = &#39; &#39;;//过渡字节
        //数据大小
        header[16] = 16; // 4 bytes: size of &#39;fmt &#39; chunk
        header[17] = 0;
        header[18] = 0;
        header[19] = 0;
        //编码方式 10H为PCM编码格式
        header[20] = 1; // format = 1
        header[21] = 0;
        //通道数
        header[22] = (byte) channels;
        header[23] = 0;
        //采样率，每个通道的播放速度
        header[24] = (byte) (longSampleRate &amp; 0xff);
        header[25] = (byte) ((longSampleRate &gt;&gt; 8) &amp; 0xff);
        header[26] = (byte) ((longSampleRate &gt;&gt; 16) &amp; 0xff);
        header[27] = (byte) ((longSampleRate &gt;&gt; 24) &amp; 0xff);
        //音频数据传送速率,采样率*通道数*采样深度/8
        header[28] = (byte) (byteRate &amp; 0xff);
        header[29] = (byte) ((byteRate &gt;&gt; 8) &amp; 0xff);
        header[30] = (byte) ((byteRate &gt;&gt; 16) &amp; 0xff);
        header[31] = (byte) ((byteRate &gt;&gt; 24) &amp; 0xff);
        // 确定系统一次要处理多少个这样字节的数据，确定缓冲区，通道数*采样位数
        header[32] = (byte) (1 * 16 / 8);
        header[33] = 0;
        //每个样本的数据位数
        header[34] = 16;
        header[35] = 0;
        //Data chunk
        header[36] = &#39;d&#39;;//data
        header[37] = &#39;a&#39;;
        header[38] = &#39;t&#39;;
        header[39] = &#39;a&#39;;
        header[40] = (byte) (totalAudioLen &amp; 0xff);
        header[41] = (byte) ((totalAudioLen &gt;&gt; 8) &amp; 0xff);
        header[42] = (byte) ((totalAudioLen &gt;&gt; 16) &amp; 0xff);
        header[43] = (byte) ((totalAudioLen &gt;&gt; 24) &amp; 0xff);
        header[44] = 0;
        out.write(header, 0, 45);
    }
</code></pre><h1 id="JSON-transmission-and-reception"><a href="#JSON-transmission-and-reception" class="headerlink" title="JSON transmission and reception"></a>JSON transmission and reception</h1><p>Based on our actual situation, use JSON for sending, storing three parameters and the WAV content, as the WAV recording is short, the entire WAV can be written into the JSON. Send the JSON twice, first sending the parameters and the file, obtaining the timestamp with the MD5 encoding, and then secondly adding this timestamp to the JSON to request the corresponding MIDI file</p>
<pre><code>    private JSONObject makejson(int request, String identifycode, String data) {
        if (identifycode == &quot;a&quot;) {
            try {
                JSONObject pack = new JSONObject();
                pack.put(&quot;request&quot;, request);
                JSONObject config = new JSONObject();
                config.put(&quot;n&quot;, lowf);
                config.put(&quot;m&quot;, highf);
                config.put(&quot;w&quot;, interval);
                pack.put(&quot;config&quot;, config);
                pack.put(&quot;data&quot;, data);
                return pack;
            } catch (JSONException e) {
                e.printStackTrace();
            }
        } else {
            try {
                JSONObject pack = new JSONObject();
                pack.put(&quot;request&quot;, request);
                pack.put(&quot;config&quot;, &quot;&quot;);
                pack.put(&quot;data&quot;, identifycode);
                return pack;
            } catch (JSONException e) {
                e.printStackTrace();
            }

        }
        return null;
    }
</code></pre><h1 id="socket-communication"><a href="#socket-communication" class="headerlink" title="socket communication"></a>socket communication</h1><p>A separate thread is opened to start the socket, and another thread is used to send and receive JSON twice. Note that when sending and receiving JSON, the JSON string should be decoded and encoded with base64, as Java’s own string may contain errors. Additionally, because the wav string is long, the server receives it in chunks. The normal practice is to add a dictionary item to store the wav length and read wav according to the length, but here we take a shortcut by adding a special character segment at the end of the file to determine whether the reception is complete, “endbidou”. Don’t ask me what it means; it’s something thought up by brothers who do conversion algorithms</p>
<pre><code>private class MsgThread extends Thread {
        @Override
        public void run() {
            File file = new File(Environment.getExternalStorageDirectory().getAbsolutePath() + &quot;/data/files/Melodia.wav&quot;);
            FileInputStream reader = null;
            try {
                reader = new FileInputStream(file);
                int len = reader.available();
                byte[] buff = new byte[len];
                reader.read(buff);
                String data = Base64.encodeToString(buff, Base64.DEFAULT);
                String senda = makejson(1, &quot;a&quot;, data).toString();
                Log.i(TAG, &quot;request1: &quot; + senda);
                OutputStream os = null;
                InputStream is = null;
                DataInputStream in = null;
                try {
                    os = soc.getOutputStream();
                    BufferedReader bra = null;
                    os.write(senda.getBytes());
                    os.write(&quot;endbidou1&quot;.getBytes());
                    os.flush();
                    Log.i(TAG, &quot;request1 send successful&quot;);
                    if (soc.isConnected()) {
                        is = soc.getInputStream();
                        bra = new BufferedReader(new InputStreamReader(is));
                        md5 = bra.readLine();
                        Log.i(TAG, &quot;md5: &quot; + md5);
                        bra.close();
                    } else
                        Log.i(TAG, &quot;socket closed while reading&quot;);
                } catch (IOException e) {
                    e.printStackTrace();
                }
                soc.close();
                startflag = 1;

                StartThread st = new StartThread();
                st.start();

                while (soc.isClosed()) ;

                String sendb = makejson(2, md5, &quot;request2&quot;).toString();
                Log.i(TAG, &quot;request2: &quot; + sendb);
                os = soc.getOutputStream();
                os.write(sendb.getBytes());
                os.write(&quot;endbidou1&quot;.getBytes());
                os.flush();
                Log.i(TAG, &quot;request2 send successful&quot;);

                is = soc.getInputStream();
                byte buffer[] = new byte[1024 * 100];
                is.read(buffer);
                Log.i(TAG, &quot;midifilecontent: &quot; + buffer.toString());
                soc.close();
                File filemid = new File(Environment.getExternalStorageDirectory().getAbsolutePath() + &quot;/data/files/Melodia.mid&quot;);
                FileOutputStream writer = null;
                writer = new FileOutputStream(filemid);
                writer.write(buffer);
                writer.close();
                Message msg = myhandler.obtainMessage();
                msg.what = 1;
                myhandler.sendMessage(msg);
            } catch (IOException e) {
                e.printStackTrace();
            }


        }
    }
</code></pre><h1 id="Recording-Effects"><a href="#Recording-Effects" class="headerlink" title="Recording Effects"></a>Recording Effects</h1><p>Audio image animation effect from Github: ShineButton. Additionally, an effect has been made for the recording button, press to record, release to complete, and slide out a certain distance to cancel</p>
<pre><code>    fabrecord.setOnTouchListener(new View.OnTouchListener() {
                @Override
                public boolean onTouch(View v, MotionEvent event) {
                    switch (event.getAction()) {
                        case MotionEvent.ACTION_DOWN:
                            uploadbt.setVisibility(View.INVISIBLE);
                            if (isUploadingIcon) {
                                isPressUpload = false;
                                uploadbt.performClick();
                                isPressUpload = true;
                                isUploadingIcon = !isUploadingIcon;
                            }

                            Log.i(TAG, &quot;ACTION_DOWN&quot;);
                            if (!shinebtstatus) {
                                shinebt.performClick();
                                shinebtstatus = true;
                            }
                            ox = event.getX();
                            oy = event.getY();

                            isRecording = true;
                            recLen = 0;
                            recTime = 0;
                            pb.setValue(0);
                            fabrecord.setImageResource(R.drawable.ic_stop_white_24dp);
                            Snackbar.make(fabrecord, &quot;开始录音&quot;, Snackbar.LENGTH_SHORT)
                                    .setAction(&quot;Action&quot;, null).show();

                            recorder = new RecordTask();
                            recorder.execute();
                            handler.postDelayed(runrecord, 0);

                            break;
                        case MotionEvent.ACTION_UP:
                            handler.removeCallbacks(runrecord);
                            Log.i(TAG, &quot;ACTION_UP&quot;);
                            if (shinebtstatus) {
                                shinebt.performClick();
                                shinebtstatus = false;
                            }
                            float x1 = event.getX();
                            float y1 = event.getY();
                            float dis1 = (x1 - ox) * (x1 - ox) + (y1 - oy) * (y1 - oy);

                            isRecording = false;
                            pb.setValue(0);
                            fabrecord.setImageResource(R.drawable.ic_fiber_manual_record_white_24dp);
                            if (dis1 &gt; 30000) {
                                Snackbar.make(fabrecord, &quot;取消录音&quot;, Snackbar.LENGTH_SHORT)
                                        .setAction(&quot;Action&quot;, null).show();
                            } else {
                                if (!isUploadingIcon) {
                                    uploadbt.setVisibility(View.VISIBLE);
                                    isPressUpload = false;
                                    uploadbt.performClick();
                                    isPressUpload = true;
                                    isUploadingIcon = !isUploadingIcon;
                                } else {

                                }

                                Snackbar.make(fabrecord, &quot;录音完成&quot;, Snackbar.LENGTH_SHORT)
                                        .setAction(&quot;Action&quot;, null).show();
                                handler.postDelayed(runreplay, 0);
                                replay();
                            }
                            break;
                        case MotionEvent.ACTION_MOVE:
                            float x2 = event.getX();
                            float y2 = event.getY();
                            float dis2 = (x2 - ox) * (x2 - ox) + (y2 - oy) * (y2 - oy);
                            if (dis2 &gt; 30000) {
                                fabrecord.setImageResource(R.drawable.ic_cancel_white_24dp);
                            } else {
                                fabrecord.setImageResource(R.drawable.ic_stop_white_24dp);
                            }
                            break;
                    }
                    return true;
                }
            });
</code></pre><h1 id="Display-musical-score"><a href="#Display-musical-score" class="headerlink" title="Display musical score"></a>Display musical score</h1><ul>
<li><p>Initially, the plan was to send and receive images through sockets, but later it was deemed too 麻烦, so the scheme was changed to use Apache to generate a corresponding image link for each conversion, which can be accessed online directly via timestamp and MD5, and if the image needs to be shared, it is first saved locally before sharing</p>
<pre><code>public void init() {
   md5 = getArguments().getString(&quot;md5&quot;);
   final String imageUri = &quot;服务器地址&quot; + md5 + &quot;_1.png&quot;;
   Log.i(&quot;play&quot;, &quot;pngfile: &quot; + imageUri);
   new Handler().postDelayed(new Runnable() {
       public void run() {
           //execute the task
           imageLoader.displayImage(imageUri, showpic);
       }
   }, 2000);

}
</code></pre></li>
</ul>
<h1 id="Communication-with-an-Electronic-Keyboard"><a href="#Communication-with-an-Electronic-Keyboard" class="headerlink" title="Communication with an Electronic Keyboard"></a>Communication with an Electronic Keyboard</h1><ul>
<li><p>Similar to uploading to a server, it also uses socket communication. After the electronic piano is modified, it receives two parameters, octave and speed, from the mobile client. Upon receiving the parameters, the Arduino plays the music and then disconnects the connection</p>
<pre><code>pianobt.setOnClickListener(new View.OnClickListener() {
           @Override
           public void onClick(View v) {
               if (!isconnected) {
                   pianoaddr = etpianoaddr.getText().toString();
                   pianoport = Integer.valueOf(etpianoport.getText().toString());
                   param[0] = 0x30;
                   StartThread st = new StartThread();
                   st.start();
                   while (!isconnected) ;
                   MsgThread ms = new MsgThread();
                   ms.start();
                   YoYo.with(Techniques.Wobble)
                           .duration(300)
                           .repeat(6)
                           .playOn(seekBaroctave);
                   while (soc.isConnected()) ;
                   try {
                       soc.close();
                   } catch (IOException e) {
                       e.printStackTrace();
                   }
                   isconnected = false;
                   Log.i(&quot;piano&quot;, &quot;socket closed&quot;);
               }
</code></pre></li>
</ul>
<pre><code>              }
          });

          samplebt.setOnClickListener(new View.OnClickListener() {
              @Override
              public void onClick(View v) {
                  pianoaddr = etpianoaddr.getText().toString();
                  pianoport = Integer.valueOf(etpianoport.getText().toString());
                  param[0] = 0x31;
                  StartThread st = new StartThread();
                  st.start();
                  while (!isconnected) ;
                  MsgThread ms = new MsgThread();
                  ms.start();
                  YoYo.with(Techniques.Wobble)
                          .duration(300)
                          .repeat(6)
                          .playOn(seekBaroctave);
                  while (soc.isConnected()) ;
                  try {
                      soc.close();
                  } catch (IOException e) {
                      e.printStackTrace();
                  }
                  isconnected = false;
                  Log.i(&quot;piano&quot;, &quot;socket closed&quot;);

              }
          });


      }

      private class StartThread extends Thread {
          @Override
          public void run() {
              try {
                  soc = new Socket(pianoaddr, pianoport);
                  if (soc.isConnected()) {//成功连接获取soc对象则发送成功消息
                      Log.i(&quot;piano&quot;, &quot;piano is Connected&quot;);
                      if (!isconnected)
                          isconnected = !isconnected;

                  } else {
                      Snackbar.make(pianobt, &quot;启动电子琴教学失败&quot;, Snackbar.LENGTH_SHORT)
                              .setAction(&quot;Action&quot;, null).show();
                      Log.i(&quot;piano&quot;, &quot;Connect Failed&quot;);
                      soc.close();
                  }
              } catch (IOException e) {
                  Snackbar.make(pianobt, &quot;启动电子琴教学失败&quot;, Snackbar.LENGTH_SHORT)
                          .setAction(&quot;Action&quot;, null).show();
                  Log.i(&quot;piano&quot;, &quot;Connect Failed&quot;);
                  e.printStackTrace();
              }
          }
      }

      private class MsgThread extends Thread {
          @Override
          public void run() {
              try {
                  OutputStream os = soc.getOutputStream();
                  os.write(param);
                  os.flush();
                  Log.i(&quot;piano&quot;, &quot;piano msg send successful&quot;);
                  Snackbar.make(pianobt, &quot;正在启动启动电子琴教学&quot;, Snackbar.LENGTH_SHORT)
                          .setAction(&quot;Action&quot;, null).show();

                  soc.close();
              } catch (IOException e) {
                  Log.i(&quot;piano&quot;, &quot;piano msg send successful failed&quot;);
                  Snackbar.make(pianobt, &quot;启动电子琴教学失败&quot;, Snackbar.LENGTH_SHORT)
                          .setAction(&quot;Action&quot;, null).show();
                  e.printStackTrace();
              }

          }
      }



# 乐谱分享
-    显示乐谱的是Github上一个魔改的ImageView:[PinchImageView](https://github.com/boycy815/PinchImageView)
-    定义其长按事件，触发一个分享的intent
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">        showpic.setOnLongClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnLongClickListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onLongClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                        <span class="type">Bitmap</span> <span class="variable">drawingCache</span> <span class="operator">=</span> getViewBitmap(showpic);</span><br><span class="line">                        <span class="keyword">if</span> (drawingCache == <span class="literal">null</span>) &#123;</span><br><span class="line">                            Log.i(<span class="string">&quot;play&quot;</span>, <span class="string">&quot;no img to save&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="type">File</span> <span class="variable">imageFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(Environment.getExternalStorageDirectory(), <span class="string">&quot;saveImageview.jpg&quot;</span>);</span><br><span class="line">                                <span class="type">Toast</span> <span class="variable">toast</span> <span class="operator">=</span> Toast.makeText(getActivity(),</span><br><span class="line">                                        <span class="string">&quot;&quot;</span>, Toast.LENGTH_LONG);</span><br><span class="line">                                toast.setGravity(Gravity.TOP, <span class="number">0</span>, <span class="number">200</span>);</span><br><span class="line">                                toast.setText(<span class="string">&quot;分享图片&quot;</span>);</span><br><span class="line">                                toast.show();</span><br><span class="line">                                FileOutputStream outStream;</span><br><span class="line">                                outStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(imageFile);</span><br><span class="line">                                drawingCache.compress(Bitmap.CompressFormat.JPEG, <span class="number">100</span>, outStream);</span><br><span class="line">                                outStream.flush();</span><br><span class="line">                                outStream.close();</span><br><span class="line">    </span><br><span class="line">                                <span class="type">Intent</span> <span class="variable">sendIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                                sendIntent.setAction(Intent.ACTION_SEND);</span><br><span class="line">                                sendIntent.putExtra(Intent.EXTRA_STREAM, Uri.fromFile(imageFile));</span><br><span class="line">                                sendIntent.setType(<span class="string">&quot;image/png&quot;</span>);</span><br><span class="line">                                getActivity().startActivity(Intent.createChooser(sendIntent, <span class="string">&quot;分享到&quot;</span>));</span><br><span class="line">    </span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                Log.i(<span class="string">&quot;play&quot;</span>, <span class="string">&quot;share img wrong&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% endlang_content %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% lang_content zh %&#125;</span><br><span class="line"># midi播放</span><br><span class="line"></span><br><span class="line">调用MediaPlayer类播放，因为不可抗因素，只能用android5<span class="number">.1</span>，没有midi库，就做简单的播放</span><br><span class="line"></span><br><span class="line">- MediaPlayer可以用外部存储，<span class="keyword">assert</span>,自建raw文件夹或者uri四种方式访问媒体文件并播放</span><br><span class="line">- 从raw文件夹中读取可以直接用player = MediaPlayer.create(<span class="built_in">this</span>, R.raw.test1)</span><br><span class="line">- Uri或者外部存储读取<span class="keyword">new</span>-&gt;setDataSource-&gt;prepare-&gt;start</span><br><span class="line"></span><br><span class="line"># 录制声音并重放</span><br><span class="line"></span><br><span class="line">参考[android中AudioRecord使用](http:<span class="comment">//blog.csdn.net/jiangliloveyou/article/details/11218555)</span></span><br><span class="line"></span><br><span class="line">```Java</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">RecordTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Void, Integer, Void&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Void... arg0)</span> &#123;</span><br><span class="line">            isRecording = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//开通输出流到指定的文件</span></span><br><span class="line">                <span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(pcmFile)));</span><br><span class="line">                <span class="comment">//根据定义好的几个配置，来获取合适的缓冲大小</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> AudioRecord.getMinBufferSize(audioRate, channelConfig, audioEncoding);</span><br><span class="line">                <span class="comment">//实例化AudioRecord</span></span><br><span class="line">                <span class="type">AudioRecord</span> <span class="variable">record</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AudioRecord</span>(MediaRecorder.AudioSource.MIC, audioRate, channelConfig, audioEncoding, bufferSize);</span><br><span class="line">                <span class="comment">//定义缓冲</span></span><br><span class="line">                <span class="type">short</span>[] buffer = <span class="keyword">new</span> <span class="title class_">short</span>[bufferSize];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//开始录制</span></span><br><span class="line">                record.startRecording();</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">//存储录制进度</span></span><br><span class="line">                <span class="comment">//定义循环，根据isRecording的值来判断是否继续录制</span></span><br><span class="line">                <span class="keyword">while</span> (isRecording) &#123;</span><br><span class="line">                    <span class="comment">//从bufferSize中读取字节，返回读取的short个数</span></span><br><span class="line">                    <span class="comment">//这里老是出现buffer overflow，不知道是什么原因，试了好几个值，都没用，TODO：待解决</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">bufferReadResult</span> <span class="operator">=</span> record.read(buffer, <span class="number">0</span>, buffer.length);</span><br><span class="line">                    <span class="comment">//循环将buffer中的音频数据写入到OutputStream中</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bufferReadResult; i++) &#123;</span><br><span class="line">                        dos.writeShort(buffer[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    publishProgress(<span class="keyword">new</span> <span class="title class_">Integer</span>(r)); <span class="comment">//向UI线程报告当前进度</span></span><br><span class="line">                    r++; <span class="comment">//自增进度值</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//录制结束</span></span><br><span class="line">                record.stop();</span><br><span class="line">                convertWaveFile();</span><br><span class="line">                dos.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</code></pre><h1 id="pcm写头文件转成wav"><a href="#pcm写头文件转成wav" class="headerlink" title="pcm写头文件转成wav"></a>pcm写头文件转成wav</h1><p>因为录制的是裸文件，pcm格式，需要自己加上wav头</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">WriteWaveFileHeader</span><span class="params">(FileOutputStream out, <span class="type">long</span> totalAudioLen, <span class="type">long</span> totalDataLen, <span class="type">long</span> longSampleRate,</span></span><br><span class="line"><span class="params">                                 <span class="type">int</span> channels, <span class="type">long</span> byteRate)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">45</span>];</span><br><span class="line">    header[<span class="number">0</span>] = <span class="string">&#x27;R&#x27;</span>; <span class="comment">// RIFF</span></span><br><span class="line">    header[<span class="number">1</span>] = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">    header[<span class="number">2</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">    header[<span class="number">3</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">    header[<span class="number">4</span>] = (<span class="type">byte</span>) (totalDataLen &amp; <span class="number">0xff</span>);<span class="comment">//数据大小</span></span><br><span class="line">    header[<span class="number">5</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">6</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">7</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">8</span>] = <span class="string">&#x27;W&#x27;</span>;<span class="comment">//WAVE</span></span><br><span class="line">    header[<span class="number">9</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    header[<span class="number">10</span>] = <span class="string">&#x27;V&#x27;</span>;</span><br><span class="line">    header[<span class="number">11</span>] = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">    <span class="comment">//FMT Chunk</span></span><br><span class="line">    header[<span class="number">12</span>] = <span class="string">&#x27;f&#x27;</span>; <span class="comment">// &#x27;fmt &#x27;</span></span><br><span class="line">    header[<span class="number">13</span>] = <span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">    header[<span class="number">14</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">    header[<span class="number">15</span>] = <span class="string">&#x27; &#x27;</span>;<span class="comment">//过渡字节</span></span><br><span class="line">    <span class="comment">//数据大小</span></span><br><span class="line">    header[<span class="number">16</span>] = <span class="number">16</span>; <span class="comment">// 4 bytes: size of &#x27;fmt &#x27; chunk</span></span><br><span class="line">    header[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">    header[<span class="number">18</span>] = <span class="number">0</span>;</span><br><span class="line">    header[<span class="number">19</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//编码方式 10H为PCM编码格式</span></span><br><span class="line">    header[<span class="number">20</span>] = <span class="number">1</span>; <span class="comment">// format = 1</span></span><br><span class="line">    header[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//通道数</span></span><br><span class="line">    header[<span class="number">22</span>] = (<span class="type">byte</span>) channels;</span><br><span class="line">    header[<span class="number">23</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//采样率，每个通道的播放速度</span></span><br><span class="line">    header[<span class="number">24</span>] = (<span class="type">byte</span>) (longSampleRate &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">25</span>] = (<span class="type">byte</span>) ((longSampleRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">26</span>] = (<span class="type">byte</span>) ((longSampleRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">27</span>] = (<span class="type">byte</span>) ((longSampleRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    <span class="comment">//音频数据传送速率,采样率*通道数*采样深度/8</span></span><br><span class="line">    header[<span class="number">28</span>] = (<span class="type">byte</span>) (byteRate &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">29</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">30</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">31</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    <span class="comment">// 确定系统一次要处理多少个这样字节的数据，确定缓冲区，通道数*采样位数</span></span><br><span class="line">    header[<span class="number">32</span>] = (<span class="type">byte</span>) (<span class="number">1</span> * <span class="number">16</span> / <span class="number">8</span>);</span><br><span class="line">    header[<span class="number">33</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//每个样本的数据位数</span></span><br><span class="line">    header[<span class="number">34</span>] = <span class="number">16</span>;</span><br><span class="line">    header[<span class="number">35</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//Data chunk</span></span><br><span class="line">    header[<span class="number">36</span>] = <span class="string">&#x27;d&#x27;</span>;<span class="comment">//data</span></span><br><span class="line">    header[<span class="number">37</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    header[<span class="number">38</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">    header[<span class="number">39</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    header[<span class="number">40</span>] = (<span class="type">byte</span>) (totalAudioLen &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">41</span>] = (<span class="type">byte</span>) ((totalAudioLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">42</span>] = (<span class="type">byte</span>) ((totalAudioLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">43</span>] = (<span class="type">byte</span>) ((totalAudioLen &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    header[<span class="number">44</span>] = <span class="number">0</span>;</span><br><span class="line">    out.write(header, <span class="number">0</span>, <span class="number">45</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="json收发"><a href="#json收发" class="headerlink" title="json收发"></a>json收发</h1><p>根据我们的实际情况，发送时使用json，存三个参数和wav内容，因为录音的wav时长较短，可以把整个wav写入json中<br>json发送两次，第一次发送参数和文件，拿到md5编码的时间戳，第二次把这个时间戳加入json中请求相应的midi文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> JSONObject <span class="title function_">makejson</span><span class="params">(<span class="type">int</span> request, String identifycode, String data)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (identifycode == <span class="string">&quot;a&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">pack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            pack.put(<span class="string">&quot;request&quot;</span>, request);</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            config.put(<span class="string">&quot;n&quot;</span>, lowf);</span><br><span class="line">            config.put(<span class="string">&quot;m&quot;</span>, highf);</span><br><span class="line">            config.put(<span class="string">&quot;w&quot;</span>, interval);</span><br><span class="line">            pack.put(<span class="string">&quot;config&quot;</span>, config);</span><br><span class="line">            pack.put(<span class="string">&quot;data&quot;</span>, data);</span><br><span class="line">            <span class="keyword">return</span> pack;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">pack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            pack.put(<span class="string">&quot;request&quot;</span>, request);</span><br><span class="line">            pack.put(<span class="string">&quot;config&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            pack.put(<span class="string">&quot;data&quot;</span>, identifycode);</span><br><span class="line">            <span class="keyword">return</span> pack;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="socket通信"><a href="#socket通信" class="headerlink" title="socket通信"></a>socket通信</h1><p>单开一个线程用于启动socket，再开一个线程写两次json收发<br>注意收发json时将json字符串用base64解码编码，java自己的string会存在错误<br>另外因为wav字符串较长，服务器接收时分块接收，正常做法是加一个字典项存wav长度，按长度读取wav，然后这里我们偷懒直接在文件尾加了一个特殊字符段用于判断是否接收完成，”endbidou”，不要问我是什么意思，做转换算法的兄弟想的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MsgThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(Environment.getExternalStorageDirectory().getAbsolutePath() + <span class="string">&quot;/data/files/Melodia.wav&quot;</span>);</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                reader = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> reader.available();</span><br><span class="line">                <span class="type">byte</span>[] buff = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line">                reader.read(buff);</span><br><span class="line">                <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> Base64.encodeToString(buff, Base64.DEFAULT);</span><br><span class="line">                <span class="type">String</span> <span class="variable">senda</span> <span class="operator">=</span> makejson(<span class="number">1</span>, <span class="string">&quot;a&quot;</span>, data).toString();</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;request1: &quot;</span> + senda);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">DataInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    os = soc.getOutputStream();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">bra</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    os.write(senda.getBytes());</span><br><span class="line">                    os.write(<span class="string">&quot;endbidou1&quot;</span>.getBytes());</span><br><span class="line">                    os.flush();</span><br><span class="line">                    Log.i(TAG, <span class="string">&quot;request1 send successful&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (soc.isConnected()) &#123;</span><br><span class="line">                        is = soc.getInputStream();</span><br><span class="line">                        bra = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">                        md5 = bra.readLine();</span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;md5: &quot;</span> + md5);</span><br><span class="line">                        bra.close();</span><br><span class="line">                    &#125; <span class="keyword">else</span></span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;socket closed while reading&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                soc.close();</span><br><span class="line">                startflag = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="type">StartThread</span> <span class="variable">st</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StartThread</span>();</span><br><span class="line">                st.start();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (soc.isClosed()) ;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">sendb</span> <span class="operator">=</span> makejson(<span class="number">2</span>, md5, <span class="string">&quot;request2&quot;</span>).toString();</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;request2: &quot;</span> + sendb);</span><br><span class="line">                os = soc.getOutputStream();</span><br><span class="line">                os.write(sendb.getBytes());</span><br><span class="line">                os.write(<span class="string">&quot;endbidou1&quot;</span>.getBytes());</span><br><span class="line">                os.flush();</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;request2 send successful&quot;</span>);</span><br><span class="line"></span><br><span class="line">                is = soc.getInputStream();</span><br><span class="line">                <span class="type">byte</span> buffer[] = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">100</span>];</span><br><span class="line">                is.read(buffer);</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;midifilecontent: &quot;</span> + buffer.toString());</span><br><span class="line">                soc.close();</span><br><span class="line">                <span class="type">File</span> <span class="variable">filemid</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(Environment.getExternalStorageDirectory().getAbsolutePath() + <span class="string">&quot;/data/files/Melodia.mid&quot;</span>);</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                writer = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filemid);</span><br><span class="line">                writer.write(buffer);</span><br><span class="line">                writer.close();</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> myhandler.obtainMessage();</span><br><span class="line">                msg.what = <span class="number">1</span>;</span><br><span class="line">                myhandler.sendMessage(msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="录音特效"><a href="#录音特效" class="headerlink" title="录音特效"></a>录音特效</h1><p>录音图像动画效果来自Github：<a target="_blank" rel="noopener" href="https://github.com/ChadCSong/ShineButton">ShineButton</a><br>另外录音按钮做了个效果，按住录音，松开完成，往外滑一定距离取消</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">fabrecord.setOnTouchListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnTouchListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouch</span><span class="params">(View v, MotionEvent event)</span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                        uploadbt.setVisibility(View.INVISIBLE);</span><br><span class="line">                        <span class="keyword">if</span> (isUploadingIcon) &#123;</span><br><span class="line">                            isPressUpload = <span class="literal">false</span>;</span><br><span class="line">                            uploadbt.performClick();</span><br><span class="line">                            isPressUpload = <span class="literal">true</span>;</span><br><span class="line">                            isUploadingIcon = !isUploadingIcon;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;ACTION_DOWN&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (!shinebtstatus) &#123;</span><br><span class="line">                            shinebt.performClick();</span><br><span class="line">                            shinebtstatus = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ox = event.getX();</span><br><span class="line">                        oy = event.getY();</span><br><span class="line"></span><br><span class="line">                        isRecording = <span class="literal">true</span>;</span><br><span class="line">                        recLen = <span class="number">0</span>;</span><br><span class="line">                        recTime = <span class="number">0</span>;</span><br><span class="line">                        pb.setValue(<span class="number">0</span>);</span><br><span class="line">                        fabrecord.setImageResource(R.drawable.ic_stop_white_24dp);</span><br><span class="line">                        Snackbar.make(fabrecord, <span class="string">&quot;开始录音&quot;</span>, Snackbar.LENGTH_SHORT)</span><br><span class="line">                                .setAction(<span class="string">&quot;Action&quot;</span>, <span class="literal">null</span>).show();</span><br><span class="line"></span><br><span class="line">                        recorder = <span class="keyword">new</span> <span class="title class_">RecordTask</span>();</span><br><span class="line">                        recorder.execute();</span><br><span class="line">                        handler.postDelayed(runrecord, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                        handler.removeCallbacks(runrecord);</span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;ACTION_UP&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (shinebtstatus) &#123;</span><br><span class="line">                            shinebt.performClick();</span><br><span class="line">                            shinebtstatus = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">float</span> <span class="variable">x1</span> <span class="operator">=</span> event.getX();</span><br><span class="line">                        <span class="type">float</span> <span class="variable">y1</span> <span class="operator">=</span> event.getY();</span><br><span class="line">                        <span class="type">float</span> <span class="variable">dis1</span> <span class="operator">=</span> (x1 - ox) * (x1 - ox) + (y1 - oy) * (y1 - oy);</span><br><span class="line"></span><br><span class="line">                        isRecording = <span class="literal">false</span>;</span><br><span class="line">                        pb.setValue(<span class="number">0</span>);</span><br><span class="line">                        fabrecord.setImageResource(R.drawable.ic_fiber_manual_record_white_24dp);</span><br><span class="line">                        <span class="keyword">if</span> (dis1 &gt; <span class="number">30000</span>) &#123;</span><br><span class="line">                            Snackbar.make(fabrecord, <span class="string">&quot;取消录音&quot;</span>, Snackbar.LENGTH_SHORT)</span><br><span class="line">                                    .setAction(<span class="string">&quot;Action&quot;</span>, <span class="literal">null</span>).show();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!isUploadingIcon) &#123;</span><br><span class="line">                                uploadbt.setVisibility(View.VISIBLE);</span><br><span class="line">                                isPressUpload = <span class="literal">false</span>;</span><br><span class="line">                                uploadbt.performClick();</span><br><span class="line">                                isPressUpload = <span class="literal">true</span>;</span><br><span class="line">                                isUploadingIcon = !isUploadingIcon;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            Snackbar.make(fabrecord, <span class="string">&quot;录音完成&quot;</span>, Snackbar.LENGTH_SHORT)</span><br><span class="line">                                    .setAction(<span class="string">&quot;Action&quot;</span>, <span class="literal">null</span>).show();</span><br><span class="line">                            handler.postDelayed(runreplay, <span class="number">0</span>);</span><br><span class="line">                            replay();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                        <span class="type">float</span> <span class="variable">x2</span> <span class="operator">=</span> event.getX();</span><br><span class="line">                        <span class="type">float</span> <span class="variable">y2</span> <span class="operator">=</span> event.getY();</span><br><span class="line">                        <span class="type">float</span> <span class="variable">dis2</span> <span class="operator">=</span> (x2 - ox) * (x2 - ox) + (y2 - oy) * (y2 - oy);</span><br><span class="line">                        <span class="keyword">if</span> (dis2 &gt; <span class="number">30000</span>) &#123;</span><br><span class="line">                            fabrecord.setImageResource(R.drawable.ic_cancel_white_24dp);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            fabrecord.setImageResource(R.drawable.ic_stop_white_24dp);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="展示乐谱"><a href="#展示乐谱" class="headerlink" title="展示乐谱"></a>展示乐谱</h1><ul>
<li><p>本来是想通过socket收发图片，后来觉得太麻烦于是把方案改成Apache对每一次转换生成相应的图片链接，通过时间戳md5直接在线访问，如果需要分享图片则先存到本地再分享</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">   md5 = getArguments().getString(<span class="string">&quot;md5&quot;</span>);</span><br><span class="line">   <span class="keyword">final</span> <span class="type">String</span> <span class="variable">imageUri</span> <span class="operator">=</span> <span class="string">&quot;服务器地址&quot;</span> + md5 + <span class="string">&quot;_1.png&quot;</span>;</span><br><span class="line">   Log.i(<span class="string">&quot;play&quot;</span>, <span class="string">&quot;pngfile: &quot;</span> + imageUri);</span><br><span class="line">   <span class="keyword">new</span> <span class="title class_">Handler</span>().postDelayed(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="comment">//execute the task</span></span><br><span class="line">           imageLoader.displayImage(imageUri, showpic);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="与电子琴通信"><a href="#与电子琴通信" class="headerlink" title="与电子琴通信"></a>与电子琴通信</h1><ul>
<li><p>类似于上传服务器，也是socket通信，电子琴改装了之后从手机客户端接收八度、速度两个参数，arduino接收到参数就播放，并由arduino断开连接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pianobt.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (!isconnected) &#123;</span><br><span class="line">                   pianoaddr = etpianoaddr.getText().toString();</span><br><span class="line">                   pianoport = Integer.valueOf(etpianoport.getText().toString());</span><br><span class="line">                   param[<span class="number">0</span>] = <span class="number">0x30</span>;</span><br><span class="line">                   <span class="type">StartThread</span> <span class="variable">st</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StartThread</span>();</span><br><span class="line">                   st.start();</span><br><span class="line">                   <span class="keyword">while</span> (!isconnected) ;</span><br><span class="line">                   <span class="type">MsgThread</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MsgThread</span>();</span><br><span class="line">                   ms.start();</span><br><span class="line">                   YoYo.with(Techniques.Wobble)</span><br><span class="line">                           .duration(<span class="number">300</span>)</span><br><span class="line">                           .repeat(<span class="number">6</span>)</span><br><span class="line">                           .playOn(seekBaroctave);</span><br><span class="line">                   <span class="keyword">while</span> (soc.isConnected()) ;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       soc.close();</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                       e.printStackTrace();</span><br><span class="line">                   &#125;</span><br><span class="line">                   isconnected = <span class="literal">false</span>;</span><br><span class="line">                   Log.i(<span class="string">&quot;piano&quot;</span>, <span class="string">&quot;socket closed&quot;</span>);</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>
<pre><code>          }
      });

      samplebt.setOnClickListener(new View.OnClickListener() {
          @Override
          public void onClick(View v) {
              pianoaddr = etpianoaddr.getText().toString();
              pianoport = Integer.valueOf(etpianoport.getText().toString());
              param[0] = 0x31;
              StartThread st = new StartThread();
              st.start();
              while (!isconnected) ;
              MsgThread ms = new MsgThread();
              ms.start();
              YoYo.with(Techniques.Wobble)
                      .duration(300)
                      .repeat(6)
                      .playOn(seekBaroctave);
              while (soc.isConnected()) ;
              try {
                  soc.close();
              } catch (IOException e) {
                  e.printStackTrace();
              }
              isconnected = false;
              Log.i(&quot;piano&quot;, &quot;socket closed&quot;);

          }
      });
</code></pre></li>
</ul>
<pre><code>    }

    private class StartThread extends Thread {
        @Override
        public void run() {
            try {
                soc = new Socket(pianoaddr, pianoport);
                if (soc.isConnected()) {//成功连接获取soc对象则发送成功消息
                    Log.i(&quot;piano&quot;, &quot;piano is Connected&quot;);
                    if (!isconnected)
                        isconnected = !isconnected;

                } else {
                    Snackbar.make(pianobt, &quot;启动电子琴教学失败&quot;, Snackbar.LENGTH_SHORT)
                            .setAction(&quot;Action&quot;, null).show();
                    Log.i(&quot;piano&quot;, &quot;Connect Failed&quot;);
                    soc.close();
                }
            } catch (IOException e) {
                Snackbar.make(pianobt, &quot;启动电子琴教学失败&quot;, Snackbar.LENGTH_SHORT)
                        .setAction(&quot;Action&quot;, null).show();
                Log.i(&quot;piano&quot;, &quot;Connect Failed&quot;);
                e.printStackTrace();
            }
        }
    }

    private class MsgThread extends Thread {
        @Override
        public void run() {
            try {
                OutputStream os = soc.getOutputStream();
                os.write(param);
                os.flush();
                Log.i(&quot;piano&quot;, &quot;piano msg send successful&quot;);
                Snackbar.make(pianobt, &quot;正在启动启动电子琴教学&quot;, Snackbar.LENGTH_SHORT)
                        .setAction(&quot;Action&quot;, null).show();

                soc.close();
            } catch (IOException e) {
                Log.i(&quot;piano&quot;, &quot;piano msg send successful failed&quot;);
                Snackbar.make(pianobt, &quot;启动电子琴教学失败&quot;, Snackbar.LENGTH_SHORT)
                        .setAction(&quot;Action&quot;, null).show();
                e.printStackTrace();
            }

        }
    }
</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 乐谱分享</span><br><span class="line">-    显示乐谱的是Github上一个魔改的ImageView:[PinchImageView](https://github.com/boycy815/PinchImageView)</span><br><span class="line">-    定义其长按事件，触发一个分享的intent</span><br><span class="line">```Java</span><br><span class="line">    showpic.setOnLongClickListener(new View.OnLongClickListener() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public boolean onLongClick(View v) &#123;</span><br><span class="line">                    Bitmap drawingCache = getViewBitmap(showpic);</span><br><span class="line">                    if (drawingCache == null) &#123;</span><br><span class="line">                        Log.i(&quot;play&quot;, &quot;no img to save&quot;);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            File imageFile = new File(Environment.getExternalStorageDirectory(), &quot;saveImageview.jpg&quot;);</span><br><span class="line">                            Toast toast = Toast.makeText(getActivity(),</span><br><span class="line">                                    &quot;&quot;, Toast.LENGTH_LONG);</span><br><span class="line">                            toast.setGravity(Gravity.TOP, 0, 200);</span><br><span class="line">                            toast.setText(&quot;分享图片&quot;);</span><br><span class="line">                            toast.show();</span><br><span class="line">                            FileOutputStream outStream;</span><br><span class="line">                            outStream = new FileOutputStream(imageFile);</span><br><span class="line">                            drawingCache.compress(Bitmap.CompressFormat.JPEG, 100, outStream);</span><br><span class="line">                            outStream.flush();</span><br><span class="line">                            outStream.close();</span><br><span class="line"></span><br><span class="line">                            Intent sendIntent = new Intent();</span><br><span class="line">                            sendIntent.setAction(Intent.ACTION_SEND);</span><br><span class="line">                            sendIntent.putExtra(Intent.EXTRA_STREAM, Uri.fromFile(imageFile));</span><br><span class="line">                            sendIntent.setType(&quot;image/png&quot;);</span><br><span class="line">                            getActivity().startActivity(Intent.createChooser(sendIntent, &quot;分享到&quot;));</span><br><span class="line"></span><br><span class="line">                        &#125; catch (IOException e) &#123;</span><br><span class="line">                            Log.i(&quot;play&quot;, &quot;share img wrong&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure></div>
<script src="https://giscus.app/client.js"
        data-repo="thinkwee/thinkwee.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnk3OTYxNjMwOA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOBL7ZNM4CkozI"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/code/" rel="tag"># code</a>
              <a href="/tags/android/" rel="tag"># android</a>
          </div>

        
  <div class="social-like a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a>
      <a class="a2a_button_facebook"></a>
      <a class="a2a_button_twitter"></a>
  </div>

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2017/02/12/MachineLearningNote/" rel="prev" title="Notes for ML">
                  <i class="fa fa-angle-left"></i> Notes for ML
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2017/03/18/Lagrange/" rel="next" title="Lagrange,KKT,PCA,SVM">
                  Lagrange,KKT,PCA,SVM <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">ICP/IP地址/域名信息备案管理系统 </a>
      <img src="http://www.beian.gov.cn/img/new/gongan.png" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=%E4%BA%ACICP%E5%A4%872023015408%E5%8F%B7" rel="noopener" target="_blank">京ICP备2023015408号 </a>
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Thinkwee</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">1m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">15:27</span>
  </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/thinkwee" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.0/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>





  <script src="/js/third-party/addtoany.js"></script>

  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"g58NgfMJBlwTyftr6hizdozq-gzGzoHsz","app_key":"1nA1tNVxeeSlAumHogP0PvSd","server_url":"https://leancloud.cn","security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://thinkwee.top/2017/03/09/dachuang/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
